<!--pages/index/index.wxml-->
<view class="index-page">

  <!-- æœç´¢æ  -->
  <view class="search-bar" bindtap="onSearch">
    <view class="search-icon">ğŸ”</view>
    <view class="search-placeholder">æœç´¢é¤å…æˆ–èœå“...</view>
  </view>

  <!-- å…¬å‘Šè½®æ’­ -->
  <swiper wx:if="{{notices.length > 0}}"
    class="notice-swiper" autoplay circular
    bindchange="onNoticeChange">
    <swiper-item wx:for="{{notices}}" wx:key="_id">
      <view class="notice-item">
        <view class="notice-type">{{item.type === 'promotion' ? 'ä¼˜æƒ ' : item.type === 'system' ? 'ç³»ç»Ÿ' : 'å…¬å‘Š'}}</view>
        <view class="notice-title">{{item.title}}</view>
      </view>
    </swiper-item>
  </swiper>

  <!-- ä¸»Tabåˆ‡æ¢ï¼šå•†å®¶ / ä»»åŠ¡ -->
  <view class="main-tab-bar">
    <view class="main-tab {{activeMainTab === 'merchants' ? 'active' : ''}}"
      bindtap="onMainTabChange" data-tab="merchants">å•†å®¶</view>
    <view class="main-tab {{activeMainTab === 'tasks' ? 'active' : ''}}"
      bindtap="onMainTabChange" data-tab="tasks">ä»»åŠ¡</view>
  </view>

  <!-- å•†å®¶è§†å›¾ -->
  <block wx:if="{{activeMainTab === 'merchants'}}">
    <!-- åˆ†åŒºç­›é€‰ -->
    <scroll-view class="zone-bar" scroll-x>
      <view wx:for="{{zones}}" wx:key="value"
        class="zone-item {{selectedZone === item.value ? 'active' : ''}}"
        bindtap="onZoneChange" data-index="{{index}}">
        {{item.label}}
      </view>
    </scroll-view>

    <!-- å•†å®¶åˆ—è¡¨ -->
    <view class="merchant-list">
      <view wx:if="{{loading && merchants.length === 0}}" class="loading-wrap">åŠ è½½ä¸­...</view>
      <view wx:elif="{{!loading && merchants.length === 0}}" class="empty-tip">
        æš‚æ— å•†å®¶ï¼Œæ•¬è¯·æœŸå¾…
      </view>
      <view wx:for="{{merchants}}" wx:key="_id"
        class="merchant-card" bindtap="onMerchantTap" data-id="{{item._id}}">
        <image class="merchant-cover" src="{{item.cover_image}}" mode="aspectFill"/>
        <view class="merchant-info">
          <view class="merchant-name">{{item.name}}</view>
          <view class="merchant-meta row">
            <view class="rating">â­ {{item.avg_rating}}</view>
            <view class="dot">Â·</view>
            <view class="location">{{item.location}}</view>
          </view>
          <view class="merchant-bottom row-between">
            <view class="min-order text-secondary text-sm">èµ·é€ Â¥{{item.min_order/100}}</view>
            <view class="status-tag {{item.status === 'open' ? 'open' : 'closed'}}">
              {{item.status === 'open' ? 'è¥ä¸šä¸­' : 'å·²æ‰“çƒŠ'}}
            </view>
          </view>
        </view>
      </view>
      <view wx:if="{{!hasMore && merchants.length > 0}}" class="no-more">æ²¡æœ‰æ›´å¤šäº†</view>
    </view>
  </block>

  <!-- ä»»åŠ¡è§†å›¾ -->
  <block wx:if="{{activeMainTab === 'tasks'}}">
    <view class="task-list">
      <view wx:if="{{tasksLoading && tasks.length === 0}}" class="loading-wrap">åŠ è½½ä¸­...</view>
      <view wx:elif="{{!tasksLoading && tasks.length === 0}}" class="empty-tip">
        æš‚æ— ä»»åŠ¡ï¼Œå»å‘å¸ƒä¸€ä¸ªå§
      </view>
      <view wx:for="{{tasks}}" wx:key="_id"
        class="task-card card" bindtap="onTaskTap" data-id="{{item._id}}">
        <view class="task-head row-between">
          <view class="task-title-text text-bold">{{item.title}}</view>
          <view class="task-reward text-primary text-bold">Â¥{{item.reward / 100}}</view>
        </view>
        <view class="task-desc-text text-secondary text-sm mt-8">{{item.description}}</view>
        <view class="task-locations text-sm mt-12" wx:if="{{item.pickup_location || item.delivery_location}}">
          <text wx:if="{{item.pickup_location}}">ğŸ“ {{item.pickup_location}}</text>
          <text wx:if="{{item.pickup_location && item.delivery_location}}"> â†’ </text>
          <text wx:if="{{item.delivery_location}}">ğŸ  {{item.delivery_location}}</text>
        </view>
        <view class="task-foot row-between mt-12">
          <view class="text-secondary text-xs">{{item.publisher_name}}</view>
          <view class="task-status-tag">{{item.statusLabel}}</view>
        </view>
      </view>
      <view wx:if="{{!tasksHasMore && tasks.length > 0}}" class="no-more">æ²¡æœ‰æ›´å¤šäº†</view>
    </view>
  </block>

</view>
