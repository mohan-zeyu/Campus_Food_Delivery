<!--pages/index/index.wxml-->
<view class="home-page">

  <view class="home-hero">
    <view class="search-shell" bindtap="onSearch">
      <view class="search-icon">ğŸ”</view>
      <view class="search-placeholder">æœç´¢é¤å…æˆ–èœå“...</view>
    </view>
  </view>

  <swiper wx:if="{{notices.length > 0}}"
    class="notice-swiper" autoplay circular
    bindchange="onNoticeChange">
    <swiper-item wx:for="{{notices}}" wx:key="_id">
      <view class="notice-item">
        <view class="notice-type">{{item.type === 'promotion' ? 'ä¼˜æƒ ' : item.type === 'system' ? 'ç³»ç»Ÿ' : 'å…¬å‘Š'}}</view>
        <view class="notice-icon">ğŸ””</view>
        <view class="notice-title">{{item.title}}</view>
      </view>
    </swiper-item>
  </swiper>

  <view wx:else class="notice-swiper">
    <view class="notice-item">
      <view class="notice-type">ç³»ç»Ÿ</view>
      <view class="notice-icon">ğŸ””</view>
      <view class="notice-title">é…é€æ—¶é—´å…¬å‘Š</view>
    </view>
  </view>

  <view class="main-tab-bar">
    <view class="main-tab {{activeMainTab === 'merchants' ? 'active' : ''}}"
      bindtap="onMainTabChange" data-tab="merchants">
      å•†å®¶
      <view wx:if="{{activeMainTab === 'merchants'}}" class="main-tab-line"></view>
    </view>
    <view class="main-tab {{activeMainTab === 'tasks' ? 'active' : ''}}"
      bindtap="onMainTabChange" data-tab="tasks">
      ä»»åŠ¡
      <view wx:if="{{activeMainTab === 'tasks'}}" class="main-tab-line"></view>
    </view>
  </view>

  <block wx:if="{{activeMainTab === 'merchants'}}">
    <scroll-view class="zone-bar" scroll-x enable-flex="true">
      <view class="zone-inner">
        <view wx:for="{{zones}}" wx:key="value"
          class="zone-item {{selectedZone === item.value ? 'active' : ''}}"
          bindtap="onZoneChange" data-index="{{index}}">
          {{item.label}}
        </view>
      </view>
    </scroll-view>

    <view class="merchant-list">
      <view wx:if="{{loading && merchants.length === 0}}" class="loading-wrap">åŠ è½½ä¸­...</view>
      <view wx:elif="{{!loading && merchants.length === 0}}" class="empty-tip">
        æš‚æ— å•†å®¶ï¼Œæ•¬è¯·æœŸå¾…
      </view>

      <view wx:for="{{merchants}}" wx:key="_id"
        class="merchant-card" bindtap="onMerchantTap" data-id="{{item._id}}">
        <view class="merchant-cover-wrap">
          <image class="merchant-cover {{item.status === 'open' ? '' : 'closed'}}" src="{{item.cover_image}}" mode="aspectFill"/>
          <view class="merchant-cover-status">{{item.status === 'open' ? 'è¥ä¸šä¸­' : 'ä¼‘æ¯ä¸­'}}</view>
        </view>

        <view class="merchant-info">
          <view class="merchant-name">{{item.name}}</view>
          <view class="merchant-meta">
            <text class="star">â˜…</text>
            <text class="rating">{{item.avg_rating}}</text>
            <text class="dot">Â·</text>
            <text class="location">{{item.location}}</text>
          </view>

          <view class="merchant-bottom">
            <view class="min-order">èµ·é€ <text class="min-order-price">Â¥{{item.min_order/100}}</text></view>
            <view class="status-pill {{item.status === 'open' ? 'open' : 'closed'}}">
              {{item.status === 'open' ? 'è¥ä¸šä¸­' : 'ä¼‘æ¯ä¸­'}}
            </view>
          </view>
        </view>
      </view>

      <view wx:if="{{!hasMore && merchants.length > 0}}" class="no-more">æ²¡æœ‰æ›´å¤šäº†</view>
    </view>
  </block>

  <block wx:if="{{activeMainTab === 'tasks'}}">
    <view class="task-list">
      <view wx:if="{{tasksLoading && tasks.length === 0}}" class="loading-wrap">åŠ è½½ä¸­...</view>
      <view wx:elif="{{!tasksLoading && tasks.length === 0}}" class="empty-tip">
        æš‚æ— ä»»åŠ¡ï¼Œå»å‘å¸ƒä¸€ä¸ªå§
      </view>

      <view wx:for="{{tasks}}" wx:key="_id"
        class="task-card" bindtap="onTaskTap" data-id="{{item._id}}">
        <view class="task-head">
          <view class="task-title-text">{{item.title}}</view>
          <view class="task-reward">Â¥{{item.reward / 100}}</view>
        </view>

        <view class="task-desc-text">{{item.description}}</view>

        <view class="task-locations" wx:if="{{item.pickup_location || item.delivery_location}}">
          <text wx:if="{{item.pickup_location}}">ğŸ“ {{item.pickup_location}}</text>
          <text wx:if="{{item.pickup_location && item.delivery_location}}"> â†’ </text>
          <text wx:if="{{item.delivery_location}}">ğŸ  {{item.delivery_location}}</text>
        </view>

        <view class="task-foot">
          <view class="task-publisher">{{item.publisher_name}}</view>
          <view class="task-status-tag">{{item.statusLabel}}</view>
        </view>
      </view>

      <view wx:if="{{!tasksHasMore && tasks.length > 0}}" class="no-more">æ²¡æœ‰æ›´å¤šäº†</view>
    </view>
  </block>

</view>
